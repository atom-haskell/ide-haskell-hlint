"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const CP = require("child_process");
const Path = require("path");
const highlight_1 = require("./highlight");
var config_1 = require("./config");
exports.config = config_1.config;
function activate(_state) { }
exports.activate = activate;
function deactivate() { }
exports.deactivate = deactivate;
function provideUPI() {
    return {
        name: 'ide-haskell-hlint',
        messageTypes: {
            lint: {
                autoScroll: true,
                uriFilter: true,
            },
        },
        events: {
            onDidSaveBuffer: (buf) => checkFile(buf, atom.config.get('ide-haskell-hlint').checkAllFilesInProject
                ? 'dir'
                : 'file'),
            onDidStopChanging: (buf) => {
                if (atom.config.get('ide-haskell-hlint').checkOnChange)
                    return checkFile(buf, 'stdin');
            },
        },
    };
}
exports.provideUPI = provideUPI;
async function checkFile(buf, mode) {
    const bufpath = buf.getPath();
    if (!bufpath)
        return;
    const rootpath = atom.project
        .getDirectories()
        .find((d) => d.contains(bufpath));
    const cwd = rootpath ? rootpath.getPath() : Path.dirname(bufpath);
    let path;
    if (mode === 'dir')
        path = cwd;
    else if (mode === 'file')
        path = bufpath;
    else if (mode === 'stdin')
        path = '-';
    else
        throw new Error(`Unknown mode ${mode}`);
    try {
        const res = await new Promise((resolve, reject) => {
            const cp = CP.execFile('hlint', ['--json', '--cross', '--no-exit-code', '--', path], {
                encoding: 'utf-8',
                cwd,
                maxBuffer: Infinity,
            }, (error, result) => {
                if (error)
                    reject(error);
                else {
                    try {
                        resolve(JSON.parse(result));
                    }
                    catch (e) {
                        reject(e);
                    }
                }
            });
            if (mode === 'stdin') {
                cp.stdin.write(buf.getText());
                cp.stdin.end();
            }
        });
        return Promise.all(res.map(async (hr) => ({
            uri: Path.normalize(hr.file === '-' ? bufpath : hr.file),
            position: { row: hr.startLine - 1, column: hr.startColumn - 1 },
            message: {
                html: `<p>${hr.hint}</p><p>Found:<pre>${await highlight_1.highlightCode(hr.from, 'source.haskell')}</pre></p>` +
                    (hr.to
                        ? `<p>Why not:<pre>${await highlight_1.highlightCode(hr.to, 'source.haskell')}</pre></p>`
                        : '') +
                    (hr.note.length ? `<p>Note: ${hr.note.join('<br>')}</p>` : ''),
            },
            severity: 'lint',
            context: hr.severity,
        })));
    }
    catch (e) {
        console.warn(e);
        if (mode === 'dir') {
            try {
                return await checkFile(buf, 'file');
            }
            catch (e) {
                console.warn(e);
                atom.notifications.addError(e.toString(), {
                    detail: e.message,
                    dismissable: true,
                });
            }
        }
        else {
            atom.notifications.addError(e.toString(), {
                detail: e.message,
                dismissable: true,
            });
        }
        return;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0Esb0NBQW1DO0FBRW5DLDZCQUE0QjtBQUM1QiwyQ0FBMkM7QUFFM0MsbUNBQWlDO0FBQXhCLDBCQUFBLE1BQU0sQ0FBQTtBQUVmLFNBQWdCLFFBQVEsQ0FBQyxNQUFhLElBQUcsQ0FBQztBQUExQyw0QkFBMEM7QUFFMUMsU0FBZ0IsVUFBVSxLQUFJLENBQUM7QUFBL0IsZ0NBQStCO0FBRS9CLFNBQWdCLFVBQVU7SUFDeEIsT0FBTztRQUNMLElBQUksRUFBRSxtQkFBbUI7UUFDekIsWUFBWSxFQUFFO1lBQ1osSUFBSSxFQUFFO2dCQUNKLFVBQVUsRUFBRSxJQUFJO2dCQUNoQixTQUFTLEVBQUUsSUFBSTthQUNoQjtTQUNGO1FBQ0QsTUFBTSxFQUFFO1lBQ04sZUFBZSxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FDdkIsU0FBUyxDQUNQLEdBQUcsRUFDSCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLHNCQUFzQjtnQkFDekQsQ0FBQyxDQUFDLEtBQUs7Z0JBQ1AsQ0FBQyxDQUFDLE1BQU0sQ0FDSjtZQUNWLGlCQUFpQixFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUU7Z0JBQ3pCLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxhQUFhO29CQUNwRCxPQUFPLFNBQVMsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFRLENBQUE7WUFDekMsQ0FBQztTQUNGO0tBQ0YsQ0FBQTtBQUNILENBQUM7QUF2QkQsZ0NBdUJDO0FBbUJELEtBQUssVUFBVSxTQUFTLENBQ3RCLEdBQW9CLEVBQ3BCLElBQThCO0lBRTlCLE1BQU0sT0FBTyxHQUFHLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtJQUM3QixJQUFJLENBQUMsT0FBTztRQUFFLE9BQU07SUFDcEIs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QUUsQ0FBQzthQUNqRTtZQUNELFFBQVEsRUFBRSxNQUFNO1lBQ2hCLE9BQU8sRUFBRSxFQUFFLENBQUMsUUFBUTtTQUNyQixDQUFDLENBQUMsQ0FDSixDQUFBO0tBQ0Y7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNWLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDZixJQUFJLElBQUksS0FBSyxLQUFLLEVBQUU7WUFDbEIsSUFBSTtnQkFDRixPQUFPLE1BQU0sU0FBUyxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQTthQUNwQztZQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNWLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQ2YsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFO29CQUN4QyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE9BQU87b0JBQ2pCLFdBQVcsRUFBRSxJQUFJO2lCQUNsQixDQUFDLENBQUE7YUFDSDtTQUNGO2FBQU07WUFDTCxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7Z0JBQ3hDLE1BQU0sRUFBRSxDQUFDLENBQUMsT0FBTztnQkFDakIsV0FBVyxFQUFFLElBQUk7YUFDbEIsQ0FBQyxDQUFBO1NBQ0g7UUFDRCxPQUFNO0tBQ1A7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgVVBJIGZyb20gJ2F0b20taGFza2VsbC11cGknXG5pbXBvcnQgKiBhcyBDUCBmcm9tICdjaGlsZF9wcm9jZXNzJ1xuaW1wb3J0ICogYXMgQXRvbSBmcm9tICdhdG9tJ1xuaW1wb3J0ICogYXMgUGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IHsgaGlnaGxpZ2h0Q29kZSB9IGZyb20gJy4vaGlnaGxpZ2h0J1xuXG5leHBvcnQgeyBjb25maWcgfSBmcm9tICcuL2NvbmZpZydcblxuZXhwb3J0IGZ1bmN0aW9uIGFjdGl2YXRlKF9zdGF0ZTogbmV2ZXIpIHt9XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWFjdGl2YXRlKCkge31cblxuZXhwb3J0IGZ1bmN0aW9uIHByb3ZpZGVVUEkoKTogVVBJLklSZWdpc3RyYXRpb25PcHRpb25zIHtcbiAgcmV0dXJuIHtcbiAgICBuYW1lOiAnaWRlLWhhc2tlbGwtaGxpbnQnLFxuICAgIG1lc3NhZ2VUeXBlczoge1xuICAgICAgbGludDoge1xuICAgICAgICBhdXRvU2Nyb2xsOiB0cnVlLFxuICAgICAgICB1cmlGaWx0ZXI6IHRydWUsXG4gICAgICB9LFxuICAgIH0sXG4gICAgZXZlbnRzOiB7XG4gICAgICBvbkRpZFNhdmVCdWZmZXI6IChidWYpID0+XG4gICAgICAgIGNoZWNrRmlsZShcbiAgICAgICAgICBidWYsXG4gICAgICAgICAgYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1obGludCcpLmNoZWNrQWxsRmlsZXNJblByb2plY3RcbiAgICAgICAgICAgID8gJ2RpcidcbiAgICAgICAgICAgIDogJ2ZpbGUnLFxuICAgICAgICApIGFzIGFueSxcbiAgICAgIG9uRGlkU3RvcENoYW5naW5nOiAoYnVmKSA9PiB7XG4gICAgICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLWhsaW50JykuY2hlY2tPbkNoYW5nZSlcbiAgICAgICAgICByZXR1cm4gY2hlY2tGaWxlKGJ1ZiwgJ3N0ZGluJykgYXMgYW55XG4gICAgICB9LFxuICAgIH0sXG4gIH1cbn1cblxudHlwZSBITGludFJlc3VsdCA9IFJlYWRvbmx5QXJyYXk8SExpbnRSZXN1bHRJdGVtPlxuXG5pbnRlcmZhY2UgSExpbnRSZXN1bHRJdGVtIHtcbiAgbW9kdWxlOiBzdHJpbmdbXVxuICBkZWNsOiBzdHJpbmdbXVxuICBzZXZlcml0eTogc3RyaW5nXG4gIGhpbnQ6IHN0cmluZ1xuICBmaWxlOiBzdHJpbmdcbiAgc3RhcnRMaW5lOiBudW1iZXJcbiAgc3RhcnRDb2x1bW46IG51bWJlclxuICBlbmRMaW5lOiBudW1iZXJcbiAgZW5kQ29sdW1uOiBudW1iZXJcbiAgZnJvbTogc3RyaW5nXG4gIHRvPzogc3RyaW5nXG4gIG5vdGU6IHN0cmluZ1tdXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNoZWNrRmlsZShcbiAgYnVmOiBBdG9tLlRleHRCdWZmZXIsXG4gIG1vZGU6ICdkaXInIHwgJ2ZpbGUnIHwgJ3N0ZGluJyxcbik6IFByb21pc2U8dW5kZWZpbmVkIHwgVVBJLklSZXN1bHRJdGVtW10+IHtcbiAgY29uc3QgYnVmcGF0aCA9IGJ1Zi5nZXRQYXRoKClcbiAgaWYgKCFidWZwYXRoKSByZXR1cm5cbiAgY29uc3Qgcm9vdHBhdGggPSBhdG9tLnByb2plY3RcbiAgICAuZ2V0RGlyZWN0b3JpZXMoKVxuICAgIC5maW5kKChkKSA9PiBkLmNvbnRhaW5zKGJ1ZnBhdGgpKVxuICBjb25zdCBjd2QgPSByb290cGF0aCA/IHJvb3RwYXRoLmdldFBhdGgoKSA6IFBhdGguZGlybmFtZShidWZwYXRoKVxuICBsZXQgcGF0aDogc3RyaW5nXG4gIGlmIChtb2RlID09PSAnZGlyJykgcGF0aCA9IGN3ZFxuICBlbHNlIGlmIChtb2RlID09PSAnZmlsZScpIHBhdGggPSBidWZwYXRoXG4gIGVsc2UgaWYgKG1vZGUgPT09ICdzdGRpbicpIHBhdGggPSAnLSdcbiAgZWxzZSB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gbW9kZSAke21vZGV9YClcbiAgdHJ5IHtcbiAgICBjb25zdCByZXMgPSBhd2FpdCBuZXcgUHJvbWlzZTxITGludFJlc3VsdD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgY3AgPSBDUC5leGVjRmlsZShcbiAgICAgICAgJ2hsaW50JyxcbiAgICAgICAgWyctLWpzb24nLCAnLS1jcm9zcycsICctLW5vLWV4aXQtY29kZScsICctLScsIHBhdGhdLFxuICAgICAgICB7XG4gICAgICAgICAgZW5jb2Rpbmc6ICd1dGYtOCcsXG4gICAgICAgICAgY3dkLFxuICAgICAgICAgIG1heEJ1ZmZlcjogSW5maW5pdHksXG4gICAgICAgIH0sXG4gICAgICAgIChlcnJvciwgcmVzdWx0KSA9PiB7XG4gICAgICAgICAgaWYgKGVycm9yKSByZWplY3QoZXJyb3IpXG4gICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICByZXNvbHZlKEpTT04ucGFyc2UocmVzdWx0IGFzIHN0cmluZykpXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgIHJlamVjdChlKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgIClcbiAgICAgIGlmIChtb2RlID09PSAnc3RkaW4nKSB7XG4gICAgICAgIGNwLnN0ZGluLndyaXRlKGJ1Zi5nZXRUZXh0KCkpXG4gICAgICAgIGNwLnN0ZGluLmVuZCgpXG4gICAgICB9XG4gICAgfSlcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoXG4gICAgICByZXMubWFwKGFzeW5jIChocikgPT4gKHtcbiAgICAgICAgdXJpOiBQYXRoLm5vcm1hbGl6ZShoci5maWxlID09PSAnLScgPyBidWZwYXRoIDogaHIuZmlsZSksXG4gICAgICAgIHBvc2l0aW9uOiB7IHJvdzogaHIuc3RhcnRMaW5lIC0gMSwgY29sdW1uOiBoci5zdGFydENvbHVtbiAtIDEgfSxcbiAgICAgICAgbWVzc2FnZToge1xuICAgICAgICAgIGh0bWw6XG4gICAgICAgICAgICBgPHA+JHtoci5oaW50fTwvcD48cD5Gb3VuZDo8cHJlPiR7YXdhaXQgaGlnaGxpZ2h0Q29kZShcbiAgICAgICAgICAgICAgaHIuZnJvbSxcbiAgICAgICAgICAgICAgJ3NvdXJjZS5oYXNrZWxsJyxcbiAgICAgICAgICAgICl9PC9wcmU+PC9wPmAgK1xuICAgICAgICAgICAgKGhyLnRvXG4gICAgICAgICAgICAgID8gYDxwPldoeSBub3Q6PHByZT4ke2F3YWl0IGhpZ2hsaWdodENvZGUoXG4gICAgICAgICAgICAgICAgICBoci50byxcbiAgICAgICAgICAgICAgICAgICdzb3VyY2UuaGFza2VsbCcsXG4gICAgICAgICAgICAgICAgKX08L3ByZT48L3A+YFxuICAgICAgICAgICAgICA6ICcnKSArXG4gICAgICAgICAgICAoaHIubm90ZS5sZW5ndGggPyBgPHA+Tm90ZTogJHtoci5ub3RlLmpvaW4oJzxicj4nKX08L3A+YCA6ICcnKSxcbiAgICAgICAgfSxcbiAgICAgICAgc2V2ZXJpdHk6ICdsaW50JyxcbiAgICAgICAgY29udGV4dDogaHIuc2V2ZXJpdHksXG4gICAgICB9KSksXG4gICAgKVxuICB9IGNhdGNoIChlKSB7XG4gICAgY29uc29sZS53YXJuKGUpXG4gICAgaWYgKG1vZGUgPT09ICdkaXInKSB7XG4gICAgICB0cnkge1xuICAgICAgICByZXR1cm4gYXdhaXQgY2hlY2tGaWxlKGJ1ZiwgJ2ZpbGUnKVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLndhcm4oZSlcbiAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKGUudG9TdHJpbmcoKSwge1xuICAgICAgICAgIGRldGFpbDogZS5tZXNzYWdlLFxuICAgICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoZS50b1N0cmluZygpLCB7XG4gICAgICAgIGRldGFpbDogZS5tZXNzYWdlLFxuICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgIH0pXG4gICAgfVxuICAgIHJldHVyblxuICB9XG59XG4iXX0=