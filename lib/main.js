"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const CP = require("child_process");
const Path = require("path");
const highlight_1 = require("./highlight");
const atom_haskell_utils_1 = require("atom-haskell-utils");
var config_1 = require("./config");
exports.config = config_1.config;
function activate(_state) {
}
exports.activate = activate;
function deactivate() {
}
exports.deactivate = deactivate;
function provideUPI() {
    return {
        name: 'ide-haskell-hlint',
        messageTypes: {
            lint: {
                autoScroll: true,
                uriFilter: true,
            },
        },
        events: {
            onDidSaveBuffer: (buf) => checkFile(buf, atom.config.get('ide-haskell-hlint').checkAllFilesInProject
                ? 'dir'
                : 'file'),
            onDidStopChanging: (buf) => {
                if (atom.config.get('ide-haskell-hlint').checkOnChange) {
                    return checkFile(buf, 'stdin');
                }
            },
        },
    };
}
exports.provideUPI = provideUPI;
async function checkFile(buf, mode) {
    const bufpath = buf.getPath();
    if (!bufpath)
        return undefined;
    const rootpath = atom.project
        .getDirectories()
        .find((d) => d.contains(bufpath));
    const cwd = rootpath ? rootpath.getPath() : Path.dirname(bufpath);
    let path;
    if (mode === 'dir')
        path = cwd;
    else if (mode === 'file')
        path = bufpath;
    else if (mode === 'stdin')
        path = '-';
    else
        throw new Error(`Unknown mode ${mode}`);
    try {
        const res = await new Promise((resolve, reject) => {
            const cp = CP.execFile(atom.config.get('ide-haskell-hlint').hlintPath, ['--json', '--cross', '--no-exit-code', '--', path], {
                encoding: 'utf-8',
                cwd,
                maxBuffer: Infinity,
            }, (error, result) => {
                if (error) {
                    reject(error);
                }
                else {
                    try {
                        resolve(JSON.parse(result));
                    }
                    catch (e) {
                        reject(e);
                    }
                }
            });
            if (mode === 'stdin') {
                const bufPath = buf.getPath();
                if (bufPath !== undefined && Path.extname(bufPath) === '.lhs') {
                    atom_haskell_utils_1.unlit(bufPath, buf.getText())
                        .then(function (text) {
                        cp.stdin.write(text);
                        cp.stdin.end();
                    })
                        .catch((e) => {
                        reject(e);
                        cp.kill();
                    });
                }
                else {
                    cp.stdin.write(buf.getText());
                    cp.stdin.end();
                }
            }
        });
        return Promise.all(res.map(async (hr) => ({
            uri: Path.normalize(hr.file === '-' ? bufpath : hr.file),
            position: { row: hr.startLine - 1, column: hr.startColumn - 1 },
            message: {
                html: `<p>${hr.hint}</p><p>Found:<pre>${await highlight_1.highlightCode(hr.from, 'source.haskell')}</pre></p>` +
                    (hr.to
                        ? `<p>Why not:<pre>${await highlight_1.highlightCode(hr.to, 'source.haskell')}</pre></p>`
                        : '') +
                    (hr.note.length ? `<p>Note: ${hr.note.join('<br>')}</p>` : ''),
            },
            severity: 'lint',
            context: hr.severity,
        })));
    }
    catch (e) {
        console.warn(e);
        if (mode === 'dir') {
            try {
                return await checkFile(buf, 'file');
            }
            catch (e) {
                console.warn(e);
                atom.notifications.addError(e.toString(), {
                    detail: e.message,
                    dismissable: true,
                });
            }
        }
        else {
            atom.notifications.addError(e.toString(), {
                detail: e.message,
                dismissable: true,
            });
        }
        return undefined;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0Esb0NBQW1DO0FBRW5DLDZCQUE0QjtBQUM1QiwyQ0FBMkM7QUFDM0MsMkRBQTBDO0FBRTFDLG1DQUFpQztBQUF4QiwwQkFBQSxNQUFNLENBQUE7QUFFZixTQUFnQixRQUFRLENBQUMsTUFBYTtBQUV0QyxDQUFDO0FBRkQsNEJBRUM7QUFFRCxTQUFnQixVQUFVO0FBRTFCLENBQUM7QUFGRCxnQ0FFQztBQUVELFNBQWdCLFVBQVU7SUFDeEIsT0FBTztRQUNMLElBQUksRUFBRSxtQkFBbUI7UUFDekIsWUFBWSxFQUFFO1lBQ1osSUFBSSxFQUFFO2dCQUNKLFVBQVUsRUFBRSxJQUFJO2dCQUNoQixTQUFTLEVBQUUsSUFBSTthQUNoQjtTQUNGO1FBQ0QsTUFBTSxFQUFFO1lBQ04sZUFBZSxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FDdkIsU0FBUyxDQUNQLEdBQUcsRUFDSCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLHNCQUFzQjtnQkFDekQsQ0FBQyxDQUFDLEtBQUs7Z0JBQ1AsQ0FBQyxDQUFDLE1BQU0sQ0FDSjtZQUNWLGlCQUFpQixFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUU7Z0JBQ3pCLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxhQUFhLEVBQUU7b0JBQ3RELE9BQU8sU0FBUyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQVEsQ0FBQTtpQkFDdEM7WUFDSCxDQUFDO1NBQ0Y7S0FDRixDQUFBO0FBQ0gsQ0FBQztBQXhCRCxnQ0F3QkM7QUFtQkQsS0FBSyxVQUFVLFNBQVMsQ0FDdEIsR0FBb0IsRUFDcEIsSUFBOEI7SUFFOUIsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFBO0lBQzdCLElBQUksQ0FBQyxP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LFFBQVEsRUFBRSxFQUFFO29CQUN4QyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE9BQU87b0JBQ2pCLFdBQVcsRUFBRSxJQUFJO2lCQUNsQixDQUFDLENBQUE7YUFDSDtTQUNGO2FBQU07WUFDTCxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7Z0JBQ3hDLE1BQU0sRUFBRSxDQUFDLENBQUMsT0FBTztnQkFDakIsV0FBVyxFQUFFLElBQUk7YUFDbEIsQ0FBQyxDQUFBO1NBQ0g7UUFDRCxPQUFPLFNBQVMsQ0FBQTtLQUNqQjtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBVUEkgZnJvbSAnYXRvbS1oYXNrZWxsLXVwaSdcbmltcG9ydCAqIGFzIENQIGZyb20gJ2NoaWxkX3Byb2Nlc3MnXG5pbXBvcnQgKiBhcyBBdG9tIGZyb20gJ2F0b20nXG5pbXBvcnQgKiBhcyBQYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgeyBoaWdobGlnaHRDb2RlIH0gZnJvbSAnLi9oaWdobGlnaHQnXG5pbXBvcnQgeyB1bmxpdCB9IGZyb20gJ2F0b20taGFza2VsbC11dGlscydcblxuZXhwb3J0IHsgY29uZmlnIH0gZnJvbSAnLi9jb25maWcnXG5cbmV4cG9ydCBmdW5jdGlvbiBhY3RpdmF0ZShfc3RhdGU6IG5ldmVyKSB7XG4gIC8qIG5vLW9wICovXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWFjdGl2YXRlKCkge1xuICAvKiBuby1vcCAqL1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJvdmlkZVVQSSgpOiBVUEkuSVJlZ2lzdHJhdGlvbk9wdGlvbnMge1xuICByZXR1cm4ge1xuICAgIG5hbWU6ICdpZGUtaGFza2VsbC1obGludCcsXG4gICAgbWVzc2FnZVR5cGVzOiB7XG4gICAgICBsaW50OiB7XG4gICAgICAgIGF1dG9TY3JvbGw6IHRydWUsXG4gICAgICAgIHVyaUZpbHRlcjogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSxcbiAgICBldmVudHM6IHtcbiAgICAgIG9uRGlkU2F2ZUJ1ZmZlcjogKGJ1ZikgPT5cbiAgICAgICAgY2hlY2tGaWxlKFxuICAgICAgICAgIGJ1ZixcbiAgICAgICAgICBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLWhsaW50JykuY2hlY2tBbGxGaWxlc0luUHJvamVjdFxuICAgICAgICAgICAgPyAnZGlyJ1xuICAgICAgICAgICAgOiAnZmlsZScsXG4gICAgICAgICkgYXMgYW55LFxuICAgICAgb25EaWRTdG9wQ2hhbmdpbmc6IChidWYpID0+IHtcbiAgICAgICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwtaGxpbnQnKS5jaGVja09uQ2hhbmdlKSB7XG4gICAgICAgICAgcmV0dXJuIGNoZWNrRmlsZShidWYsICdzdGRpbicpIGFzIGFueVxuICAgICAgICB9XG4gICAgICB9LFxuICAgIH0sXG4gIH1cbn1cblxudHlwZSBITGludFJlc3VsdCA9IFJlYWRvbmx5QXJyYXk8SExpbnRSZXN1bHRJdGVtPlxuXG5pbnRlcmZhY2UgSExpbnRSZXN1bHRJdGVtIHtcbiAgbW9kdWxlOiBzdHJpbmdbXVxuICBkZWNsOiBzdHJpbmdbXVxuICBzZXZlcml0eTogc3RyaW5nXG4gIGhpbnQ6IHN0cmluZ1xuICBmaWxlOiBzdHJpbmdcbiAgc3RhcnRMaW5lOiBudW1iZXJcbiAgc3RhcnRDb2x1bW46IG51bWJlclxuICBlbmRMaW5lOiBudW1iZXJcbiAgZW5kQ29sdW1uOiBudW1iZXJcbiAgZnJvbTogc3RyaW5nXG4gIHRvPzogc3RyaW5nXG4gIG5vdGU6IHN0cmluZ1tdXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNoZWNrRmlsZShcbiAgYnVmOiBBdG9tLlRleHRCdWZmZXIsXG4gIG1vZGU6ICdkaXInIHwgJ2ZpbGUnIHwgJ3N0ZGluJyxcbik6IFByb21pc2U8dW5kZWZpbmVkIHwgVVBJLklSZXN1bHRJdGVtW10+IHtcbiAgY29uc3QgYnVmcGF0aCA9IGJ1Zi5nZXRQYXRoKClcbiAgaWYgKCFidWZwYXRoKSByZXR1cm4gdW5kZWZpbmVkXG4gIGNvbnN0IHJvb3RwYXRoID0gYXRvbS5wcm9qZWN0XG4gICAgLmdldERpcmVjdG9yaWVzKClcbiAgICAuZmluZCgoZCkgPT4gZC5jb250YWlucyhidWZwYXRoKSlcbiAgY29uc3QgY3dkID0gcm9vdHBhdGggPyByb290cGF0aC5nZXRQYXRoKCkgOiBQYXRoLmRpcm5hbWUoYnVmcGF0aClcbiAgbGV0IHBhdGg6IHN0cmluZ1xuICBpZiAobW9kZSA9PT0gJ2RpcicpIHBhdGggPSBjd2RcbiAgZWxzZSBpZiAobW9kZSA9PT0gJ2ZpbGUnKSBwYXRoID0gYnVmcGF0aFxuICBlbHNlIGlmIChtb2RlID09PSAnc3RkaW4nKSBwYXRoID0gJy0nXG4gIGVsc2UgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIG1vZGUgJHttb2RlfWApXG4gIHRyeSB7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgbmV3IFByb21pc2U8SExpbnRSZXN1bHQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGNwID0gQ1AuZXhlY0ZpbGUoXG4gICAgICAgIGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwtaGxpbnQnKS5obGludFBhdGgsXG4gICAgICAgIFsnLS1qc29uJywgJy0tY3Jvc3MnLCAnLS1uby1leGl0LWNvZGUnLCAnLS0nLCBwYXRoXSxcbiAgICAgICAge1xuICAgICAgICAgIGVuY29kaW5nOiAndXRmLTgnLFxuICAgICAgICAgIGN3ZCxcbiAgICAgICAgICBtYXhCdWZmZXI6IEluZmluaXR5LFxuICAgICAgICB9LFxuICAgICAgICAoZXJyb3IsIHJlc3VsdCkgPT4ge1xuICAgICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgcmVqZWN0KGVycm9yKVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICByZXNvbHZlKEpTT04ucGFyc2UocmVzdWx0IGFzIHN0cmluZykpXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgIHJlamVjdChlKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgIClcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTp0b3RhbGl0eS1jaGVja1xuICAgICAgaWYgKG1vZGUgPT09ICdzdGRpbicpIHtcbiAgICAgICAgY29uc3QgYnVmUGF0aCA9IGJ1Zi5nZXRQYXRoKClcbiAgICAgICAgaWYgKGJ1ZlBhdGggIT09IHVuZGVmaW5lZCAmJiBQYXRoLmV4dG5hbWUoYnVmUGF0aCkgPT09ICcubGhzJykge1xuICAgICAgICAgIHVubGl0KGJ1ZlBhdGgsIGJ1Zi5nZXRUZXh0KCkpXG4gICAgICAgICAgICAudGhlbihmdW5jdGlvbih0ZXh0KSB7XG4gICAgICAgICAgICAgIGNwLnN0ZGluLndyaXRlKHRleHQpXG4gICAgICAgICAgICAgIGNwLnN0ZGluLmVuZCgpXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKChlOiBFcnJvcikgPT4ge1xuICAgICAgICAgICAgICByZWplY3QoZSlcbiAgICAgICAgICAgICAgY3Aua2lsbCgpXG4gICAgICAgICAgICB9KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNwLnN0ZGluLndyaXRlKGJ1Zi5nZXRUZXh0KCkpXG4gICAgICAgICAgY3Auc3RkaW4uZW5kKClcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFxuICAgICAgcmVzLm1hcChhc3luYyAoaHIpID0+ICh7XG4gICAgICAgIHVyaTogUGF0aC5ub3JtYWxpemUoaHIuZmlsZSA9PT0gJy0nID8gYnVmcGF0aCA6IGhyLmZpbGUpLFxuICAgICAgICBwb3NpdGlvbjogeyByb3c6IGhyLnN0YXJ0TGluZSAtIDEsIGNvbHVtbjogaHIuc3RhcnRDb2x1bW4gLSAxIH0sXG4gICAgICAgIG1lc3NhZ2U6IHtcbiAgICAgICAgICBodG1sOlxuICAgICAgICAgICAgYDxwPiR7aHIuaGludH08L3A+PHA+Rm91bmQ6PHByZT4ke2F3YWl0IGhpZ2hsaWdodENvZGUoXG4gICAgICAgICAgICAgIGhyLmZyb20sXG4gICAgICAgICAgICAgICdzb3VyY2UuaGFza2VsbCcsXG4gICAgICAgICAgICApfTwvcHJlPjwvcD5gICtcbiAgICAgICAgICAgIChoci50b1xuICAgICAgICAgICAgICA/IGA8cD5XaHkgbm90OjxwcmU+JHthd2FpdCBoaWdobGlnaHRDb2RlKFxuICAgICAgICAgICAgICAgICAgaHIudG8sXG4gICAgICAgICAgICAgICAgICAnc291cmNlLmhhc2tlbGwnLFxuICAgICAgICAgICAgICAgICl9PC9wcmU+PC9wPmBcbiAgICAgICAgICAgICAgOiAnJykgK1xuICAgICAgICAgICAgKGhyLm5vdGUubGVuZ3RoID8gYDxwPk5vdGU6ICR7aHIubm90ZS5qb2luKCc8YnI+Jyl9PC9wPmAgOiAnJyksXG4gICAgICAgIH0sXG4gICAgICAgIHNldmVyaXR5OiAnbGludCcsXG4gICAgICAgIGNvbnRleHQ6IGhyLnNldmVyaXR5LFxuICAgICAgfSkpLFxuICAgIClcbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUud2FybihlKVxuICAgIGlmIChtb2RlID09PSAnZGlyJykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IGNoZWNrRmlsZShidWYsICdmaWxlJylcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS53YXJuKGUpXG4gICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihlLnRvU3RyaW5nKCksIHtcbiAgICAgICAgICBkZXRhaWw6IGUubWVzc2FnZSxcbiAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKGUudG9TdHJpbmcoKSwge1xuICAgICAgICBkZXRhaWw6IGUubWVzc2FnZSxcbiAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICB9KVxuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkXG4gIH1cbn1cbiJdfQ==